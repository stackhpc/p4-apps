# Deploy the slurm-driven rebuild script + dependencies.
# See top-level README for usage.
#
# NB: assumes an access credential has been added to e.g. /etc/openstack - done using terraform here.

- hosts:
  - cluster_batch
  gather_facts: false
  become: true
  tasks:
    - name: install python3
      yum:
        name: python3
    - name: create venv
      command: python3 -m venv /opt/slurm-tools
      args:
        creates: /opt/slurm-tools
    - name: install slurm-openstack-tools
      shell: |
        source /opt/slurm-tools/bin/activate
        pip install --upgrade pip
        pip install git+https://github.com/stackhpc/slurm-openstack-tools.git
      args:
        creates: /opt/slurm-tools/bin/slurm-openstack-rebuild
    - name: add RebootProgram to slurm.conf
      lineinfile:
        path: "{{ openhpc_slurm_conf.location }}"
        regexp: "^RebootProgram=.*$"
        line: "RebootProgram=/opt/slurm-tools/bin/slurm-openstack-rebuild"
      register: slurm_conf
    - name: reconfigure slurm
      shell:
        cmd: "scontrol reconfigure"
      when: slurm_conf.changed
      run_once: true

# for py2:
# sudo yum install python3
# sudo yum install python-virtualenv
# virtualenv --python=python3 venv
# . venv/bin/activate
# pip install -U pip
# pip install "openstacksdk<=0.39" # for py2
# pip install "python-openstackclient<=4.0.0" # for py2
# pip install "subprocess32>=3.5.0" # for py2

